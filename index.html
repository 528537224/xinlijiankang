<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å¿ƒç†æ²™ç›˜ | ä¸“ä¸šæ•´åˆç‰ˆ v3.0</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Microsoft YaHei",Arial,Helvetica,sans-serif}
body{display:flex;height:100vh;overflow:hidden;background:#f5f5f5}
.sidebar{width:220px;background:#fafafa;border-right:1px solid #ddd;overflow-y:auto;padding:8px;font-size:13px}
.category-title{font-weight:bold;margin:6px 0 4px;color:#555}
.item{display:flex;align-items:center;padding:4px 6px;border:1px solid #ddd;border-radius:4px;margin-bottom:3px;cursor:grab;background:#fff;font-size:12px}
.item .emoji{font-size:22px;margin-right:6px}

/* æ²™ç›˜å±…ä¸­ */
.sandbox-wrapper{flex:1;display:flex;align-items:center;justify-content:center;background:#e8e4df}
.sandbox{position:relative;width:80%;height:80%;max-width:800px;max-height:600px;background:#e8d9a9;border-radius:12px;box-shadow:0 0 16px rgba(0,0,0,.15);overflow:hidden;cursor:grab;
background-image:
  radial-gradient(circle at 25% 30%,#d9c896 1.2px,transparent 1.2px),
  radial-gradient(circle at 50% 70%,#d0bd88 1px,transparent 1px),
  radial-gradient(circle at 75% 45%,#d9c896 1.4px,transparent 1.4px);
background-size:45px 45px,65px 65px,55px 55px}

#canvas{position:absolute;top:0;left:0;z-index:1}
.sandbox-item{position:absolute;display:flex;align-items:center;justify-content:center;width:64px;height:64px;z-index:2;cursor:move}
.sandbox-item .emoji{font-size:48px}

.controls{position:absolute;top:6px;right:6px;z-index:10;background:#fff;border:1px solid #ccc;border-radius:6px;padding:4px 6px;font-size:12px}
.controls button{margin:0 2px;padding:2px 6px;font-size:12px}

.modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.4);z-index:999}
.modal-content{position:relative;background:#fff;margin:8% auto;padding:16px;border-radius:8px;width:320px;font-size:14px}
.add-form{display:flex;flex-direction:column;gap:4px}
.add-form input,.add-form select,.add-form button{padding:4px;font-size:12px}
.color-picker{width:100%;height:24px}

#exportBtn{background:#4CAF50;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:14px;margin-bottom:8px}
#exportBtn:hover{background:#45a049}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<!-- ä¾§è¾¹æ ï¼šåˆå¹¶ä¸¤å¥—æ²™å…·ï¼Œä¿ç•™æ‰€æœ‰ -->
<div class="sidebar">
  <!-- äººç‰©ç±» -->
  <div class="category">
    <div class="category-title">äººç‰©ç±»</div>
    <div class="item" draggable="true" data-type="person" data-name="è‡ªæˆ‘"><span class="emoji">ğŸ‘¤</span><span class="txt">è‡ªæˆ‘</span></div>
    <div class="item" draggable="true" data-type="person" data-name="å®¶äºº"><span class="emoji">ğŸ‘ª</span><span class="txt">å®¶äºº</span></div>
    <div class="item" draggable="true" data-type="person" data-name="æœ‹å‹"><span class="emoji">ğŸ‘«</span><span class="txt">æœ‹å‹</span></div>
    <div class="item" draggable="true" data-type="person" data-name="è€å¸ˆ"><span class="emoji">ğŸ‘©â€ğŸ«</span><span class="txt">è€å¸ˆ</span></div>
    <div class="item" draggable="true" data-type="person" data-name="æƒå¨"><span class="emoji">ğŸ‘®</span><span class="txt">æƒå¨</span></div>
  </div>
  <!-- åŠ¨ç‰©ç±» -->
  <div class="category">
    <div class="category-title">åŠ¨ç‰©ç±»</div>
    <div class="item" draggable="true" data-type="animal" data-name="å°ç¾Š"><span class="emoji">ğŸ</span><span class="txt">å°ç¾Š</span></div>
    <div class="item" draggable="true" data-type="animal" data-name="ç‹—"><span class="emoji">ğŸ•</span><span class="txt">ç‹—</span></div>
    <div class="item" draggable="true" data-type="animal" data-name="çŒ«"><span class="emoji">ğŸ±</span><span class="txt">çŒ«</span></div>
    <div class="item" draggable="true" data-type="animal" data-name="é¸Ÿ"><span class="emoji">ğŸ¦</span><span class="txt">é¸Ÿ</span></div>
    <div class="item" draggable="true" data-type="animal" data-name="é±¼"><span class="emoji">ğŸŸ</span><span class="txt">é±¼</span></div>
    <div class="item" draggable="true" data-type="animal" data-name="é‡å…½"><span class="emoji">ğŸ¦</span><span class="txt">é‡å…½</span></div>
    <div class="item" draggable="true" data-type="animal" data-name="é£é¸Ÿ"><span class="emoji">ğŸ¦…</span><span class="txt">é£é¸Ÿ</span></div>
  </div>
  <!-- è‡ªç„¶ç±» -->
  <div class="category">
    <div class="category-title">è‡ªç„¶ç±»</div>
    <div class="item" draggable="true" data-type="nature" data-name="å¤ªé˜³"><span class="emoji">â˜€ï¸</span><span class="txt">å¤ªé˜³</span></div>
    <div class="item" draggable="true" data-type="nature" data-name="æœˆäº®"><span class="emoji">ğŸŒ™</span><span class="txt">æœˆäº®</span></div>
    <div class="item" draggable="true" data-type="nature" data-name="æ˜Ÿæ˜Ÿ"><span class="emoji">â­</span><span class="txt">æ˜Ÿæ˜Ÿ</span></div>
    <div class="item" draggable="true" data-type="nature" data-name="æ²³æµ"><span class="emoji">ğŸŒŠ</span><span class="txt">æ²³æµ</span></div>
    <div class="item" draggable="true" data-type="nature" data-name="å±±å³°"><span class="emoji">â›°ï¸</span><span class="txt">å±±å³°</span></div>
    <div class="item" draggable="true" data-type="nature" data-name="æ ‘æœ¨"><span class="emoji">ğŸŒ³</span><span class="txt">æ ‘æœ¨</span></div>
  </div>
  <!-- å»ºç­‘ç±» -->
  <div class="category">
    <div class="category-title">å»ºç­‘ç±»</div>
    <div class="item" draggable="true" data-type="building" data-name="å®¶"><span class="emoji">ğŸ </span><span class="txt">å®¶</span></div>
    <div class="item" draggable="true" data-type="building" data-name="å­¦æ ¡"><span class="emoji">ğŸ«</span><span class="txt">å­¦æ ¡</span></div>
    <div class="item" draggable="true" data-type="building" data-name="å›´æ "><span class="emoji">ğŸš§</span><span class="txt">å›´æ </span></div>
    <div class="item" draggable="true" data-type="building" data-name="å•†åº—"><span class="emoji">ğŸª</span><span class="txt">å•†åº—</span></div>
    <div class="item" draggable="true" data-type="building" data-name="åŒ»é™¢"><span class="emoji">ğŸ¥</span><span class="txt">åŒ»é™¢</span></div>
    <div class="item" draggable="true" data-type="building" data-name="ç‰¢ç¬¼"><span class="emoji">ğŸªŸ</span><span class="txt">ç‰¢ç¬¼</span></div>
    <div class="item" draggable="true" data-type="building" data-name="å›´å¢™"><span class="emoji">ğŸ§±</span><span class="txt">å›´å¢™</span></div>
  </div>
  <!-- èŠ±ç±» -->
  <div class="category">
    <div class="category-title">èŠ±ç±»</div>
    <div class="item" draggable="true" data-type="flower" data-name="å‘æ—¥è‘µ"><span class="emoji">ğŸŒ»</span><span class="txt">å‘æ—¥è‘µ</span></div>
    <div class="item" draggable="true" data-type="flower" data-name="ç«ç‘°"><span class="emoji">ğŸŒ¹</span><span class="txt">ç«ç‘°</span></div>
    <div class="item" draggable="true" data-type="flower" data-name="éƒé‡‘é¦™"><span class="emoji">ğŸŒ·</span><span class="txt">éƒé‡‘é¦™</span></div>
    <div class="item" draggable="true" data-type="flower" data-name="æ¨±èŠ±"><span class="emoji">ğŸŒ¸</span><span class="txt">æ¨±èŠ±</span></div>
  </div>
  <!-- æ ‘ç±» -->
  <div class="category">
    <div class="category-title">æ ‘ç±»</div>
    <div class="item" draggable="true" data-type="tree" data-name="æ¾æ ‘"><span class="emoji">ğŸŒ²</span><span class="txt">æ¾æ ‘</span></div>
    <div class="item" draggable="true" data-type="tree" data-name="æ¤°æ ‘"><span class="emoji">ğŸŒ´</span><span class="txt">æ¤°æ ‘</span></div>
    <div class="item" draggable="true" data-type="tree" data-name="è½å¶æ ‘"><span class="emoji">ğŸŒ³</span><span class="txt">è½å¶æ ‘</span></div>
    <div class="item" draggable="true" data-type="tree" data-name="åœ£è¯æ ‘"><span class="emoji">ğŸ„</span><span class="txt">åœ£è¯æ ‘</span></div>
  </div>
  <!-- ç‰©å“ç±» -->
  <div class="category">
    <div class="category-title">ç‰©å“ç±»</div>
    <div class="item" draggable="true" data-type="object" data-name="ä¹¦æœ¬"><span class="emoji">ğŸ“š</span><span class="txt">ä¹¦æœ¬</span></div>
    <div class="item" draggable="true" data-type="object" data-name="ç©å…·"><span class="emoji">ğŸ§¸</span><span class="txt">ç©å…·</span></div>
    <div class="item" draggable="true" data-type="object" data-name="ä¹å™¨"><span class="emoji">ğŸ¸</span><span class="txt">ä¹å™¨</span></div>
    <div class="item" draggable="true" data-type="object" data-name="ç”µè„‘"><span class="emoji">ğŸ’»</span><span class="txt">ç”µè„‘</span></div>
    <div class="item" draggable="true" data-type="object" data-name="æ¸¸æˆæœº"><span class="emoji">ğŸ®</span><span class="txt">æ¸¸æˆæœº</span></div>
    <div class="item" draggable="true" data-type="object" data-name="æ­¦å™¨"><span class="emoji">âš”ï¸</span><span class="txt">æ­¦å™¨</span></div>
    <div class="item" draggable="true" data-type="object" data-name="ç«ç„°"><span class="emoji">ğŸ”¥</span><span class="txt">ç«ç„°</span></div>
  </div>
  <!-- é£Ÿç‰©ç±» -->
  <div class="category">
    <div class="category-title">é£Ÿç‰©ç±»</div>
    <div class="item" draggable="true" data-type="food" data-name="ç±³é¥­"><span class="emoji">ğŸš</span><span class="txt">ç±³é¥­</span></div>
    <div class="item" draggable="true" data-type="food" data-name="é¢æ¡"><span class="emoji">ğŸœ</span><span class="txt">é¢æ¡</span></div>
    <div class="item" draggable="true" data-type="food" data-name="æ±‰å ¡"><span class="emoji">ğŸ”</span><span class="txt">æ±‰å ¡</span></div>
    <div class="item" draggable="true" data-type="food" data-name="è–¯æ¡"><span class="emoji">ğŸŸ</span><span class="txt">è–¯æ¡</span></div>
    <div class="item" draggable="true" data-type="food" data-name="è›‹ç³•"><span class="emoji">ğŸ‚</span><span class="txt">è›‹ç³•</span></div>
  </div>
  <!-- æ°´æœç±» -->
  <div class="category">
    <div class="category-title">æ°´æœç±»</div>
    <div class="item" draggable="true" data-type="fruit" data-name="è‹¹æœ"><span class="emoji">ğŸ</span><span class="txt">è‹¹æœ</span></div>
    <div class="item" draggable="true" data-type="fruit" data-name="æ¡ƒå­"><span class="emoji">ğŸ‘</span><span class="txt">æ¡ƒå­</span></div>
    <div class="item" draggable="true" data-type="fruit" data-name="è‘¡è„"><span class="emoji">ğŸ‡</span><span class="txt">è‘¡è„</span></div>
    <div class="item" draggable="true" data-type="fruit" data-name="é¦™è•‰"><span class="emoji">ğŸŒ</span><span class="txt">é¦™è•‰</span></div>
    <div class="item" draggable="true" data-type="fruit" data-name="è‰è“"><span class="emoji">ğŸ“</span><span class="txt">è‰è“</span></div>
  </div>
  <!-- æƒ…ç»ª Emoji -->
  <div class="category">
    <div class="category-title">æƒ…ç»ª Emoji</div>
    <div class="item" draggable="true" data-type="emotion" data-name="å¼€å¿ƒ"><span class="emoji">ğŸ˜Š</span><span class="txt">å¼€å¿ƒ</span></div>
    <div class="item" draggable="true" data-type="emotion" data-name="ä¼¤å¿ƒ"><span class="emoji">ğŸ˜¢</span><span class="txt">ä¼¤å¿ƒ</span></div>
    <div class="item" draggable="true" data-type="emotion" data-name="æ„¤æ€’"><span class="emoji">ğŸ¤¬</span><span class="txt">æ„¤æ€’</span></div>
    <div class="item" draggable="true" data-type="emotion" data-name="å®³ç¾"><span class="emoji">ğŸ˜³</span><span class="txt">å®³ç¾</span></div>
    <div class="item" draggable="true" data-type="emotion" data-name="å›°å€¦"><span class="emoji">ğŸ˜´</span><span class="txt">å›°å€¦</span></div>
  </div>
  <!-- å…¶å®ƒ -->
  <div class="category">
    <div class="category-title">å…¶å®ƒ</div>
    <div class="item" draggable="true" data-type="other" data-name="è´è¶ç»“"><span class="emoji">ğŸ€</span><span class="txt">è´è¶ç»“</span></div>
    <div class="item" draggable="true" data-type="other" data-name="çˆ±å¿ƒ"><span class="emoji">â¤ï¸</span><span class="txt">çˆ±å¿ƒ</span></div>
    <div class="item" draggable="true" data-type="other" data-name="ç‚¸å¼¹"><span class="emoji">ğŸ’£</span><span class="txt">ç‚¸å¼¹</span></div>
    <div class="item" draggable="true" data-type="other" data-name="è„šå°"><span class="emoji">ğŸ‘£</span><span class="txt">è„šå°</span></div>
    <div class="item" draggable="true" data-type="cactus" data-name="ä»™äººæŒ"><span class="emoji">ğŸŒµ</span><span class="txt">ä»™äººæŒ</span></div>
  </div>
  <!-- è‡ªå®šä¹‰æ·»åŠ  -->
  <div class="category">
    <div class="category-title">æ·»åŠ æ–°ç‰©å“</div>
    <div class="add-form">
      <input type="text" id="newEmoji" placeholder="Emoji" maxlength="2">
      <input type="text" id="newName" placeholder="åç§°">
      <select id="newType">
        <option value="animal">åŠ¨ç‰©ç±»</option><option value="flower">èŠ±ç±»</option><option value="grass">è‰ç±»</option>
        <option value="tree">æ ‘ç±»</option><option value="cactus">ä»™äººæŒ</option><option value="emotion">æƒ…ç»ªç±»</option>
      </select>
      <input type="color" id="newColor" class="color-picker" value="#4CAF50">
      <button onclick="addNewItem()">æ·»åŠ </button>
    </div>
  </div>
</div>

<!-- æ²™ç›˜ -->
<div class="sandbox-wrapper">
  <div class="sandbox" id="sandbox">
    <canvas id="canvas"></canvas>
  </div>
</div>

<!-- é¡¶éƒ¨æ§åˆ¶ -->
<div class="controls">
  <button onclick="togglePaintMode()">ğŸ–Œï¸ ç”»ç¬”</button>
  <button onclick="clearCanvas()">æ¸…ç©ºç”»ç¬”</button>
  <button onclick="zoomIn()">â•æ”¾å¤§</button>
  <button onclick="zoomOut()">â–ç¼©å°</button>
  <button onclick="undoEmoji()">æ’¤é”€</button>
  <button onclick="resetSandbox()">é‡ç½®</button>
  <button onclick="openSaveModal()">ä¿å­˜</button>
  <button onclick="openHistoryModal()">åŠ è½½</button>
  <button onclick="openTeacherLogin()">æ•™å¸ˆ</button>
  <button onclick="generateReport()">æŠ¥å‘Š</button>
</div>

<!-- ç”»ç¬”å·¥å…·æ  -->
<div id="paintToolbar" style="display:none;position:absolute;top:40px;right:6px;background:#fff;border:1px solid #ccc;border-radius:4px;padding:4px;font-size:12px">
  é¢œè‰²ï¼š<input type="color" id="paintColor" value="#000">
  ç²—ç»†ï¼š<input type="range" id="paintSize" min="1" max="20" value="3">
  <button onclick="togglePaintMode()">å…³é—­</button>
</div>

<!-- å¼¹çª— -->
<div class="modal" id="saveModal"><div class="modal-content">
  <h3>ä¿å­˜æ²™ç›˜</h3>
  å§“åï¼š<input id="studentName"><br>
  å¯†ç ï¼š<input type="password" id="studentPassword"><br>
  <button onclick="saveSandbox()">ä¿å­˜</button>
  <button onclick="closeModal('saveModal')">å–æ¶ˆ</button>
</div></div>

<div class="modal" id="historyModal"><div class="modal-content">
  <h3>åŠ è½½è®°å½•</h3>
  å§“åï¼š<input id="historyName"><br>
  å¯†ç ï¼š<input type="password" id="historyPassword"><br>
  <button onclick="loadHistory()">åŠ è½½</button>
  <button onclick="closeModal('historyModal')">å–æ¶ˆ</button>
</div></div>

<div class="modal" id="teacherModal"><div class="modal-content">
  <h3>æ•™å¸ˆç™»å½•</h3>
  å¯†ç ï¼š<input type="password" id="teacherPassword"><br>
  <button onclick="teacherLogin()">ç™»å½•</button>
  <button onclick="closeModal('teacherModal')">å–æ¶ˆ</button>
</div></div>

<!-- æ•™å¸ˆç«¯ -->
<div class="modal" id="teacherPanel" style="display:none">
  <div class="modal-content" style="width:90%;max-width:900px">
    <h3>å­¦ç”Ÿå¿ƒç†çŠ¶æ€æ€»è§ˆ</h3>
    <button id="exportBtn">å¯¼å‡ºæˆå›¾ç‰‡</button>
    <button onclick="exportCharts('excel')">å¯¼å‡ºExcel</button>
    <button onclick="generateQuickReport()">âš¡ å¿«é€Ÿå‘ˆç°</button>
    <div id="teacherContent"></div>
    <div id="quickReport" style="display:none;margin-top:10px;background:#f0f4ff;padding:10px;border-radius:6px"></div>
    <div style="display:flex;gap:20px;margin-top:20px;flex-wrap:wrap">
      <div style="flex:1;min-width:300px"><canvas id="scoreChart" height="300"></canvas></div>
      <div style="flex:1;min-width:300px"><canvas id="distributionChart" height="300"></canvas></div>
    </div>
    <div id="detailedReports" style="margin-top:20px"></div>
    <button onclick="closeModal('teacherPanel')">å…³é—­</button>
  </div>
</div>

<div class="modal" id="reportModal"><div class="modal-content">
  <h3>åˆ†ææŠ¥å‘Š</h3>
  <div id="reportContent"></div>
  <button onclick="closeModal('reportModal')">å…³é—­</button>
</div></div>

<script>
/* ===== é€šç”¨å˜é‡ ===== */
let sandboxItems=[],history=[[]],itemCounter=0,zoomLevel=1;
const sandbox=document.getElementById('sandbox');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
let isDrawing=false,lastX=0,lastY=0;
let paintMode=false;
let strokeData=[];

/* ç”»å¸ƒè‡ªé€‚åº” */
function resizeCanvas(){
  canvas.width=sandbox.clientWidth;
  canvas.height=sandbox.clientHeight;
}
resizeCanvas();
window.addEventListener('resize',resizeCanvas);

/* ç»˜ç”»åŠŸèƒ½ */
function startDraw(e){
  if(!paintMode) return;
  isDrawing=true;
  [lastX,lastY]=[e.offsetX,e.offsetY];
}
function draw(e){
  if(!isDrawing) return;
  ctx.strokeStyle=document.getElementById('paintColor').value;
  ctx.lineWidth=document.getElementById('paintSize').value;
  ctx.lineCap='round';
  ctx.beginPath();
  ctx.moveTo(lastX,lastY);
  ctx.lineTo(e.offsetX,e.offsetY);
  ctx.stroke();
  [lastX,lastY]=[e.offsetX,e.offsetY];
  strokeData.push({x:e.offsetX,y:e.offsetY});
}
function stopDraw(){
  isDrawing=false;
}
canvas.addEventListener('mousedown',startDraw);
canvas.addEventListener('mousemove',draw);
canvas.addEventListener('mouseup',stopDraw);
canvas.addEventListener('mouseout',stopDraw);

function togglePaintMode(){
  paintMode=!paintMode;
  const tb=document.getElementById('paintToolbar');
  tb.style.display=paintMode?'block':'none';
}

function clearCanvas(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

/* æ”¾å¤§/ç¼©å° */
function zoomIn(){
  zoomLevel=Math.min(3,zoomLevel*1.2);
  sandbox.style.transform=`scale(${zoomLevel})`;
}
function zoomOut(){
  zoomLevel=Math.max(0.3,zoomLevel/1.2);
  sandbox.style.transform=`scale(${zoomLevel})`;
}
sandbox.addEventListener('wheel',e=>{
  e.preventDefault();
  zoomLevel+=e.deltaY>0?-0.1:0.1;
  zoomLevel=Math.max(0.3,Math.min(3,zoomLevel));
  sandbox.style.transform=`scale(${zoomLevel})`;
});

/* æ‹–æ‹½ Emoji */
document.addEventListener('DOMContentLoaded',()=>{
  [...document.querySelectorAll('.item')].forEach(it=>{
    it.addEventListener('dragstart',e=>{
      e.dataTransfer.setData('text/plain',JSON.stringify({
        emoji:it.querySelector('.emoji').textContent,
        name:it.dataset.name,
        type:it.dataset.type,
        color:getComputedStyle(it).getPropertyValue('--item-color')||'#000'
      }));
    });
  });
  sandbox.addEventListener('dragover',e=>e.preventDefault());
  sandbox.addEventListener('drop',e=>{
    e.preventDefault();
    const {emoji,name,type,color}=JSON.parse(e.dataTransfer.getData('text/plain'));
    const node=document.createElement('div');node.className='sandbox-item';
    node.id='item-'+ ++itemCounter;
    node.style.left=(e.offsetX-32)+'px';node.style.top=(e.offsetY-32)+'px';
    node.innerHTML=`<span class="emoji" style="color:${color}">${emoji}</span>`;
    makeDraggable(node);sandbox.appendChild(node);
    sandboxItems.push({id:node.id,type,name,x:e.offsetX,y:e.offsetY,color,emoji});
    history.push(JSON.parse(JSON.stringify(sandboxItems)));
  });
});

function makeDraggable(el){
  let isDragging=false,initX,initY;
  el.addEventListener('mousedown',e=>{
    initX=e.offsetX;initY=e.offsetY;
    isDragging=true;
    const drag=e=>{
      if(!isDragging)return;
      const rect=sandbox.getBoundingClientRect();
      const x=(e.clientX-rect.left)/zoomLevel;
      const y=(e.clientY-rect.top)/zoomLevel;
      el.style.left=(x-32)+'px';el.style.top=(y-32)+'px';
      const it=sandboxItems.find(i=>i.id===el.id);
      if(it){it.x=x;it.y=y;}
    };
    const stop=()=>{
      isDragging=false;
      history.push(JSON.parse(JSON.stringify(sandboxItems)));
      document.removeEventListener('mousemove',drag);
      document.removeEventListener('mouseup',stop);
    };
    document.addEventListener('mousemove',drag);
    document.addEventListener('mouseup',stop);
  });
}

function addNewItem(){
  const emoji=document.getElementById('newEmoji').value.trim();
  const name=document.getElementById('newName').value.trim();
  const type=document.getElementById('newType').value;
  const color=document.getElementById('newColor').value;
  if(!emoji||!name){alert('è¯·è¾“å…¥Emojiå’Œåç§°');return;}
  const item=document.createElement('div');item.className='item';item.draggable=true;
  item.dataset.type=type;item.dataset.name=name;
  item.style.setProperty('--item-color',color);
  item.innerHTML=`<span class="emoji" style="color:${color}">${emoji}</span><span class="txt">${name}</span>`;
  item.addEventListener('dragstart',e=>{
    e.dataTransfer.setData('text/plain',JSON.stringify({emoji,name,type,color}));
  });
  document.querySelector('.sidebar').appendChild(item);
  document.getElementById('newEmoji').value='';
  document.getElementById('newName').value='';
}

/* é€šç”¨åŠŸèƒ½ */
function undoEmoji(){
  if(history.length>1){
    history.pop();
    renderItems();
  }
}
function resetSandbox(){
  clearCanvas();
  document.querySelectorAll('.sandbox-item').forEach(n=>n.remove());
  sandboxItems=[];itemCounter=0;zoomLevel=1;
  sandbox.style.transform='scale(1)';
}
function renderItems(){
  document.querySelectorAll('.sandbox-item').forEach(n=>n.remove());
  sandboxItems.forEach(it=>{
    const n=document.createElement('div');n.className='sandbox-item';
    n.id=it.id;n.style.left=(it.x-32)+'px';n.style.top=(it.y-32)+'px';
    n.innerHTML=`<span class="emoji" style="color:${it.color}">${it.emoji}</span>`;
    makeDraggable(n);sandbox.appendChild(n);
  });
}

function openSaveModal(){document.getElementById('saveModal').style.display='block';}
function openHistoryModal(){document.getElementById('historyModal').style.display='block';}
function openTeacherLogin(){document.getElementById('teacherModal').style.display='block';}
function closeModal(id){document.getElementById(id).style.display='none';}

/* ===== å¿ƒç†åˆ†æå¼•æ“ï¼ˆæ–‡ä»¶1å®Œæ•´ä¿ç•™ï¼‰ ===== */
const PsychologicalAnalyzer = {
  symbolMeanings:{
    'self':{meaning:'è‡ªæˆ‘è®¤çŸ¥',states:['self_esteem','identity']},
    'family':{meaning:'å®¶åº­å…³ç³»',states:['attachment','conflict']},
    'authority':{meaning:'æƒå¨æ€åº¦',states:['rebellion','submission']},
    'wild':{meaning:'æœ¬èƒ½å†²åŠ¨',states:['aggression','fear']},
    'pet':{meaning:'æƒ…æ„Ÿä¾é™„',states:['nurturing','loneliness']},
    'bird':{meaning:'è‡ªç”±æ¸´æœ›',states:['aspiration','escape']},
    'house':{meaning:'å®‰å…¨æ„Ÿ',states:['security','isolation']},
    'school':{meaning:'ç¤¾ä¼šé€‚åº”',states:['achievement','anxiety']},
    'hospital':{meaning:'æ²»æ„ˆéœ€æ±‚',states:['trauma','healing']},
    'tree':{meaning:'ç”Ÿå‘½èƒ½é‡',states:['growth','stagnation']},
    'mountain':{meaning:'ç›®æ ‡éšœç¢',states:['challenge','perseverance']},
    'water':{meaning:'æƒ…ç»ªæµåŠ¨',states:['emotional_flooding','calm']},
    'fire':{meaning:'ç ´åå‡€åŒ–',states:['anger','transformation']},
    'weapon':{meaning:'æ”»å‡»é˜²å¾¡',states:['hostility','protection']},
    'cage':{meaning:'é™åˆ¶ä¿æŠ¤',states:['entrapment','safety']},
    'wall':{meaning:'è¾¹ç•Œéš”ç¦»',states:['defensiveness','security']}
  },

  analyzeLayout:(items)=>{
    const center={x:canvas.width/2,y:canvas.height/2};
    const zones={center:0,top:0,bottom:0,left:0,right:0,corners:0};
    items.forEach(item=>{
      const dx=item.x-center.x,dy=item.y-center.y;
      if(Math.abs(dx)<100&&Math.abs(dy)<100) zones.center++;
      else if(dy<-100) zones.top++;
      else if(dy>100) zones.bottom++;
      else if(dx<-100) zones.left++;
      else if(dx>100) zones.right++;
      else zones.corners++;
    });
    return zones;
  },

  analyzePsychology:(items,drawingFeatures)=>{
    const calcScore=(indicators,multiplier=1)=>Math.min(items.reduce((sum,item)=>sum+(indicators[item.name]||0),0)*multiplier,100);
    const analysis={
      anxiety:{score:calcScore({'å­¦æ ¡':3,'æƒå¨':2,'æ­¦å™¨':4,'ç«ç„°':3,'ç‰¢ç¬¼':2},5)+(items.length>10?10:0),level:'low',description:'ç„¦è™‘ç›¸å…³ç‰©å“ä¸å¯†åº¦'},
      depression:{score:calcScore({'æ²³æµ':3,'åŒ»é™¢':4,'å›´å¢™':3,'ç‰¢ç¬¼':3},5)+(PsychologicalAnalyzer.analyzeLayout(items).corners*5),level:'low',description:'æŠ‘éƒè±¡å¾ä¸è¾¹ç¼˜åŒ–'},
      loneliness:{score:items.filter(item=>!items.some(other=>Math.abs(item.x-other.x)<50&&Math.abs(item.y-other.y)<50&&item!==other)).length*15,level:'low',description:'ç‰©å“å­¤ç«‹ç¨‹åº¦'},
      aggression:{score:calcScore({'æ­¦å™¨':15,'ç«ç„°':10,'é‡å…½':10},1)+(items.filter((_,i,arr)=>arr.slice(i+1).some(other=>Math.abs(_.x-other.x)<80&&Math.abs(_.y-other.y)<80)).length*5),level:'low',description:'æ”»å‡»æ€§è±¡å¾ä¸å†²çª'},
      distrust:{score:calcScore({'å›´å¢™':10,'ç‰¢ç¬¼':8,'æ­¦å™¨':5},3)+(PsychologicalAnalyzer.analyzeLayout(items).center===0?15:0),level:'low',description:'é˜²å¾¡æ€§å¸ƒå±€'},
      low_self_esteem:{score:items.filter(i=>i.name==='è‡ªæˆ‘').length===0?50:items.filter(i=>i.name==='è‡ªæˆ‘').reduce((sum,item)=>sum+Math.sqrt(Math.pow(item.x-canvas.width/2,2)+Math.pow(item.y-canvas.height/2,2))/10,0),level:'low',description:'è‡ªæˆ‘å½¢è±¡ç¼ºå¤±æˆ–è¾¹ç¼˜åŒ–'},
      distraction:{score:Math.min(items.length*6,100),level:'low',description:'ç‰©å“æ•°é‡ä¸æ³¨æ„åŠ›'},
      confusion:{score:(new Set(items.map(i=>i.type)).size>3?25:0)+(PsychologicalAnalyzer.analyzeLayout(items).center===0?20:0),level:'low',description:'ç±»åˆ«æ··ä¹±ä¸ä¸­å¿ƒç¼ºå¤±'}
    };

    if(drawingFeatures){
      if(drawingFeatures.pressure?.highVariance) analysis.anxiety.score+=10;
      if(drawingFeatures.velocity?.highAverage) analysis.aggression.score+=10;
      if(drawingFeatures.structure?.lowStraightness) analysis.confusion.score+=10;
    }

    Object.values(analysis).forEach(state=>{
      state.level=state.score>60?'high':state.score>30?'medium':'low';
    });

    return analysis;
  },

  generateSuggestions:(analysis)=>{
    const suggestions=[];
    const highRiskStates=Object.entries(analysis).filter(([_,data])=>data.level==='high');
    const interventions={
      anxiety:{priority:'é«˜',intervention:'æ¸è¿›å¼æ”¾æ¾è®­ç»ƒ',technique:'æ¯æ—¥15åˆ†é’Ÿæ·±å‘¼å¸+è‚Œè‚‰æ”¾æ¾',duration:'4-6å‘¨'},
      depression:{priority:'é«˜',intervention:'è®¤çŸ¥è¡Œä¸ºç–—æ³•',technique:'ç§¯æäº‹ä»¶è®°å½•+æƒ…ç»ªæ—¥è®°',duration:'8-12å‘¨'},
      loneliness:{priority:'ä¸­',intervention:'å›¢ä½“æ²™ç›˜æ´»åŠ¨',technique:'åˆä½œå¼æ²™ç›˜+åŒä¼´äº’åŠ¨',duration:'æŒç»­è¿›è¡Œ'},
      aggression:{priority:'é«˜',intervention:'æ„¤æ€’ç®¡ç†è®­ç»ƒ',technique:'æƒ…ç»ªæ¸©åº¦è®¡+æš‚åœæŠ€å·§',duration:'6-8å‘¨'},
      distrust:{priority:'ä¸­',intervention:'ä¿¡ä»»å»ºç«‹æ¸¸æˆ',technique:'ç›²äººæ–¹é˜µ+åˆ†äº«åœˆ',duration:'4å‘¨'},
      low_self_esteem:{priority:'ä¸­',intervention:'ä¼˜ç‚¹è½°ç‚¸+æˆå°±å›é¡¾',technique:'æ¯æ—¥è‡ªæˆ‘è‚¯å®šæ¸…å•',duration:'4å‘¨'},
      distraction:{priority:'ä½',intervention:'ä¸“æ³¨åŠ›è®­ç»ƒ',technique:'ç•ªèŒ„å·¥ä½œæ³•+æ­£å¿µç»ƒä¹ ',duration:'2-4å‘¨'},
      confusion:{priority:'ä¸­',intervention:'ç›®æ ‡è®¾å®šè®­ç»ƒ',technique:'SMARTç›®æ ‡+åˆ†æ­¥è®¡åˆ’',duration:'3-6å‘¨'}
    };
    highRiskStates.forEach(([state])=>{if(interventions[state]) suggestions.push(interventions[state]);});
    return suggestions;
  }
};

/* ===== å¢å¼ºå­˜å‚¨ç³»ç»Ÿ ===== */
class EnhancedRecordManager {
  constructor(){
    this.storageKey='sandboxes_v3';
  }
  saveRecord(data){
    const records=this.getAllRecords();
    const existing=records.find(r=>r.name===data.name);
    if(existing) Object.assign(existing,data);
    else records.push(data);
    localStorage.setItem(this.storageKey,JSON.stringify(records));
  }
  getAllRecords(){
    return JSON.parse(localStorage.getItem(this.storageKey)||'[]');
  }
  generateDetailedReport(student){
    const items=student.items||[];
    const drawingFeatures=student.strokeAnalysis;
    const psychology=PsychologicalAnalyzer.analyzePsychology(items,drawingFeatures);
    const suggestions=PsychologicalAnalyzer.generateSuggestions(psychology);
    return{
      student,
      psychology,
      suggestions,
      layout:PsychologicalAnalyzer.analyzeLayout(items),
      summary:{
        name:student.name,
        riskLevel:Object.values(psychology).filter(s=>s.level==='high').length>2?'é«˜':Object.values(psychology).some(s=>s.level!=='low')?'ä¸­':'ä½',
        concerns:Object.entries(psychology).filter(([_,data])=>data.level!=='low')
          .map(([state])=>({anxiety:'ç„¦è™‘',depression:'æŠ‘éƒ',loneliness:'å­¤ç‹¬',aggression:'æ”»å‡»æ€§',distrust:'ä¸ä¿¡ä»»',low_self_esteem:'è‡ªå‘',distraction:'æ³¨æ„åŠ›åˆ†æ•£',confusion:'è¿·èŒ«'}[state]||state))
      }
    };
  }
  exportToExcel(){
    const records=this.getAllRecords();
    const data=records.map(record=>{
      const report=this.generateDetailedReport(record);
      return{
        'å§“å':record.name,
        'æ—¥æœŸ':new Date(record.timestamp).toLocaleDateString(),
        ...Object.fromEntries(Object.entries(report.psychology).map(([k,v])=>[k,v.score])),
        'é£é™©ç­‰çº§':report.summary.riskLevel,
        'ä¸»è¦å…³æ³¨ç‚¹':report.summary.concerns.join('ã€')
      };
    });
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"å­¦ç”Ÿå¿ƒç†åˆ†æ");
    XLSX.writeFile(wb,`å¿ƒç†åˆ†ææŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.xlsx`);
  }
}
const recordManager=new EnhancedRecordManager();

/* ===== ä¸šåŠ¡é€»è¾‘ ===== */
function saveSandbox(){
  const name=document.getElementById('studentName').value.trim();
  const pwd=document.getElementById('studentPassword').value.trim();
  if(!name||!pwd){alert('è¯·å¡«å†™å§“åå’Œå¯†ç ');return;}
  const data={
    name,
    pwd,
    items:sandboxItems,
    canvasData:canvas.toDataURL(),
    strokeAnalysis:{
      pressure:{average:0,highVariance:strokeData.length>100},
      velocity:{average:strokeData.length/100,highAverage:strokeData.length>200},
      structure:{average:0.5,lowStraightness:strokeData.length<50}
    },
    timestamp:new Date().toISOString()
  };
  recordManager.saveRecord(data);
  alert('æ²™ç›˜å·²ä¿å­˜ï¼ˆå«ç»˜ç”»+å¿ƒç†åˆ†æï¼‰');
  closeModal('saveModal');
}

function loadHistory(){
  const name=document.getElementById('historyName').value.trim();
  const pwd=document.getElementById('historyPassword').value.trim();
  if(!name||!pwd){alert('è¯·å¡«å†™å§“åå’Œå¯†ç ');return;}
  const list=recordManager.getAllRecords();
  const stu=list.find(i=>i.name===name&&i.pwd===pwd);
  if(stu){
    resetSandbox();
    const img=new Image();
    img.onload=()=>ctx.drawImage(img,0,0);
    img.src=stu.canvasData;
    sandboxItems=stu.items||[];
    renderItems();
    history=[JSON.parse(JSON.stringify(sandboxItems))];
    alert(`${stu.name} çš„è®°å½•å·²åŠ è½½`);
    closeModal('historyModal');
  }else{alert('æœªæ‰¾åˆ°è®°å½•æˆ–å¯†ç é”™è¯¯');}
}

/* æ•™å¸ˆç«¯ */
function teacherLogin(){
  if(document.getElementById('teacherPassword').value==='teacher2025'){
    closeModal('teacherModal');
    const records=recordManager.getAllRecords();
    const reports=records.map(r=>recordManager.generateDetailedReport(r));
    document.getElementById('teacherContent').innerHTML=buildTeacherTable(records);
    renderCharts(reports);
    const container=document.getElementById('detailedReports');
    container.innerHTML=reports.map(report=>`
      <div style="border:1px solid #ddd;border-radius:6px;padding:10px;margin-bottom:10px">
        <h4>ğŸ‘¤ ${report.student.name} - ${new Date(report.student.timestamp).toLocaleDateString()}</h4>
        <div style="margin:6px 0">
          ${Object.entries(report.psychology).map(([state,data])=>`<span style="margin:2px;padding:2px 6px;border-radius:10px;font-size:12px;background:${data.level==='high'?'#ffebee':data.level==='medium'?'#fff3e0':'#e8f5e8'}">${state}:${data.score}</span>`).join('')}
        </div>
        <h5>ğŸ¯ å¹²é¢„å»ºè®®ï¼š</h5>
        <ul style="margin-left:20px;font-size:12px">
          ${report.suggestions.map(s=>`<li><strong>${s.priority}ä¼˜å…ˆçº§:</strong> ${s.intervention} â†’ ${s.technique} (${s.duration})</li>`).join('')}
        </ul>
      </div>
    `).join('');
    document.getElementById('teacherPanel').style.display='block';
  }else{alert('æ•™å¸ˆå¯†ç é”™è¯¯');}
}

function buildTeacherTable(list){
  let html=`<table id="scoreTable" border="1" cellpadding="6" style="width:100%;border-collapse:collapse;font-size:14px">
    <thead><tr><th>å­¦ç”Ÿ</th><th>æœ€æ–°å¾—åˆ†</th><th>çŠ¶æ€</th><th>æœ€åä¿å­˜æ—¶é—´</th></tr></thead><tbody>`;
  list.forEach(s=>{
    const report=recordManager.generateDetailedReport(s);
    const avg=Object.values(report.psychology).reduce((sum,v)=>sum+v.score,0)/Object.values(report.psychology).length;
    const status=avg>60?'éœ€è¦å…³æ³¨':avg>30?'ä¸€èˆ¬':'å¥åº·';
    html+=`<tr>
      <td>${s.name}</td>
      <td>${Math.round(avg)}</td>
      <td>${status}</td>
      <td>${new Date(s.timestamp).toLocaleString()}</td>
    </tr>`;
  });
  html+='</tbody></table>';
  return html;
}

function renderCharts(reports){
  const scoreCtx=document.getElementById('scoreChart').getContext('2d');
  new Chart(scoreCtx,{
    type:'bar',
    data:{
      labels:reports.map(r=>r.student.name),
      datasets:[{
        label:'ç»¼åˆé£é™©å¾—åˆ†',
        data:reports.map(r=>Math.round(Object.values(r.psychology).reduce((sum,v)=>sum+v.score,0)/Object.values(r.psychology).length)),
        backgroundColor:reports.map(r=>{
          const avg=Object.values(r.psychology).reduce((sum,v)=>sum+v.score,0)/Object.values(r.psychology).length;
          return avg>60?'#ff6384':avg>30?'#ffcd56':'#36a2eb';
        })
      }]
    },
    options:{responsive:true,scales:{y:{beginAtZero:true,max:100}}}
  });

  const distCtx=document.getElementById('distributionChart').getContext('2d');
  const scores=reports.map(r=>Math.round(Object.values(r.psychology).reduce((sum,v)=>sum+v.score,0)/Object.values(r.psychology).length));
  const distribution=Array(11).fill(0);
  scores.forEach(s=>distribution[Math.min(Math.floor(s/10),10)]++);
  new Chart(distCtx,{
    type:'pie',
    data:{
      labels:['0-10','11-20','21-30','31-40','41-50','51-60','61-70','71-80','81-90','91-100'],
      datasets:[{data:distribution,backgroundColor:['#ff0000','#ff3300','#ff6600','#ff9900','#ffcc00','#ffff00','#ccff00','#99ff00','#66ff00','#00ff00']}]
    },
    options:{responsive:true,plugins:{legend:{position:'right'}}}
  });
}

function generateQuickReport(){
  const records=recordManager.getAllRecords();
  const summaries=records.map(r=>recordManager.generateDetailedReport(r).summary);
  const needAttention=summaries.filter(s=>s.riskLevel!=='ä½');
  document.getElementById('quickReport').innerHTML=`
    <p><strong>âš ï¸ éœ€è¦å…³æ³¨çš„å­¦ç”Ÿ (${needAttention.length}äºº)ï¼š</strong></p>
    ${needAttention.length>0?needAttention.map(s=>`<p>â€¢ <strong>${s.name}</strong> (${s.riskLevel}é£é™©) â†’ ${s.concerns.join('ã€')}</p>`).join(''):'<p>âœ… ä»Šæ—¥æ‰€æœ‰å­¦ç”Ÿå¿ƒç†çŠ¶æ€è‰¯å¥½</p>'}
  `;
  document.getElementById('quickReport').style.display='block';
}

function exportCharts(format){
  if(format==='excel') recordManager.exportToExcel();
  else{
    html2canvas(document.querySelector('#teacherPanel .modal-content')).then(canvas=>{
      const link=document.createElement('a');
      link.download=`å¿ƒç†çŠ¶æ€æ€»è§ˆ_${new Date().toISOString().split('T')[0]}.png`;
      link.href=canvas.toDataURL();
      link.click();
    });
  }
}

/* å­¦ç”Ÿä¸ªäººæŠ¥å‘Š */
function generateReport(){
  if(sandboxItems.length===0){alert('è¯·å…ˆæ‘†æ”¾å…ƒç´ ');return;}
  const report=recordManager.generateDetailedReport({items:sandboxItems});
  let analysis='',score=100;
  Object.entries(report.psychology).forEach(([k,v])=>{
    if(v.level==='high'){analysis+=`${k}å¾—åˆ†${v.score}ï¼Œå­˜åœ¨æ˜æ˜¾é£é™©ï¼›`;score-=20;}
    else if(v.level==='medium'){analysis+=`${k}å¾—åˆ†${v.score}ï¼Œéœ€å…³æ³¨ï¼›`;score-=10;}
  });
  const status=score<60?'éœ€è¦å…³æ³¨':score<80?'ä¸€èˆ¬':'å¥åº·';
  document.getElementById('reportContent').innerHTML=`
    <div class="analysis-report">
      <h3>å¿ƒç†åˆ†ææŠ¥å‘Š</h3>
      <p>å¿ƒç†å¥åº·è¯„ä¼°ï¼š${status}ï¼ˆ${score}/100ï¼‰</p>
      <p>${analysis}</p>
      <ul>${report.suggestions.map(s=>`<li>${s.priority}ä¼˜å…ˆçº§ï¼š${s.intervention}ï¼ˆ${s.technique}ï¼‰</li>`).join('')}</ul>
    </div>`;
  document.getElementById('reportModal').style.display='block';
}
</script>
</body>
</html>